<!DOCTYPE html>
<title>NZ BGP topology map</title>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 2px;
  opacity: .7;
}

.highlight_node {
  stroke: black;
  opacity: 1.0;
  transform: scale(1.2, 1.2);
}

.fade_node {
  opacity: 0.2;
}

.endnode {
  opacity: .5;
  stroke: #fff;
  stroke-width: 1px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.highlight_link {
  stroke: #000;
  stroke-opacity: 1.0;
}

.fade_link {
  stroke-opacity: 0.2;
}

.d3-tip {
    line-height: 1;
    font-weight: bold;
    background: green;
    color: black;
    opacity: 0.8;
}

.tip-label {
    color: Orange;
}

.tip-info {
    color: Blue;
}

</style>
<body>
<script src="/d3/d3.min.js"></script>
<script src="/d3/d3-tip.js"></script>
<script>

function zoom() {
    svg.attr("transform", "translate("+ d3.event.translate + ")scale(" + d3.event.scale +")");
}

var width = 2000,
    height = 800;

// var color = d3.scale.category10();
var color = d3.scale.ordinal()
    .domain(["unk", "IX", "AU", "NZ"])
    .range(["#bcbd22","red","gold", "black"]);

var charge = d3.scale.linear()
    .domain([8, 32])
    .range([40, 5000])

var linksIndex = {};

var force = d3.layout.force()
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .call(d3.behavior.zoom().scaleExtent([1,8]).on("zoom", zoom))
    .append("g");

var tip = d3.tip()
    .attr('class', 'd3-tip')
    .offset([-10, 0])
    .html(function(d) {
        return "<span class='tip-label'>AS:</span> <span class='tip-info'>" + d.id + "</span><br>" +
            "<span class='tip-label'>Name: </span> <span class='tip-info'>" + d.name + "</span><br>" +
            "<span class='tip-label'>Peers: </span> <span class='tip-info'>" + d.degree + "</span>";
    });

svg.call(tip);

d3.json("data/nz-bgp-map.json", function(error, graph) {

  force
      .nodes(graph.nodes)
      .links(graph.links)

  var k = Math.sqrt(graph.nodes.length / (width * height));

  // Store additional info about the links for latter use
  storeLinks(graph);

  force
//    .charge(function(d) { return -Math.pow( Math.sqrt(d.degree), 2.0) })
    .charge(function(d) { return -charge(d.radius); })
//    .linkDistance(function(d) { return 3*Math.sqrt( d.source.degree + d.target.degree ) })
    .linkDistance(15)
//    .friction(0.9)
    .gravity(2.5)
    .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value);
});

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("circle")
      .attr("class", function(d) { if (d.degree == 1) { return "endnode"; } else
      return "node"; })
//      .attr("r", function(d) { return 8+10*(Math.log(d.degree) / Math.LN10) })
      .attr("r", function(d) { return d.radius; })
      .style("stroke-width", function(d) { return d.stroke })
      .style("fill", function(d) { return color(d.group); })
      .on("mouseover", highlight_node)
      .on("mouseout", clear_node)
      .call(force.drag);

//  node.append("title")
////      .text(function(d) { return d.name + '(' + d.degree + ')'; });

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });

});

function storeLinks(g) {
    g.links.forEach(function(d) {
        if (linksIndex[d.source] === undefined) {
            linksIndex[d.source] = d3.set();
        }

        if (linksIndex[d.target] === undefined) {
            linksIndex[d.target] = d3.set();
        }

        linksIndex[d.source].add([d.target]);
        linksIndex[d.target].add([d.source]);
    });
}

function highlight_node(d) {
    // Highlight all the nodes linked to current node
    d3.selectAll(".node").classed("highlight_node", function(o) { return linksIndex[d.index].has(o.index); });
    // Fade all the other nodes
    d3.selectAll(".node").classed("fade_node", function(o) {
        return (! linksIndex[d.index].has(o.index));
    });
    // Highlight this node
    d3.select(this).classed({"highlight_node": true, "fade_node": false});
    // Highlight the links
    highlight_links(d);
    // Activate the information tip
    tip.show(d);
}

function clear_node(d) {
//    d3.select(this).classed("highlight_node", false);
    d3.selectAll(".node").classed({ "highlight_node": false,
    "fade_node": false});
    d3.selectAll(".link").classed("highlight_link", false);
    tip.hide(d);
}

function highlight_links(node) {
    d3.selectAll(".link").classed("highlight_link", function(o) {
        if (o.source == node || o.target == node) { return true; }});
}

</script>
